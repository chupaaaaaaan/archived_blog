<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>コーヒーと線香と万年筆</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="./css/theme.css" rel="stylesheet" type="text/css">
    <link href="./css/highlight.css" rel="stylesheet" type="text/css">
<!-- コメント機能は別途追加する -->
<!-- {% if site.comments and site.isso != '' %} -->
<!-- <script data-isso="{{ site.isso }}" src="/js/embed.min.js"></script> -->
<!-- {% endif %} -->

</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="./">コーヒーと線香と万年筆</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="./">Home</a></li>
                    <li class="active visible-xs-block"><a href="./links.html">Links</a></li>
                    <li class="active"><a href="./archive.html">Archive</a></li>
                    <li class="active"><a href="./about.html">About</a></li>
                    <li class="active"><a href="./atom.xml">RSS</a></li>
                    
                      <li class="active"><a href="https://github.com/chupaaaaaaan">Github</a></li>
                    
                    
                      <li class="active"><a href="https://qiita.com/chupaaaaaaan">Qiita</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
自分で調べて試してみるのが、一番自分の力になるんだ
</div>

<div class="sidebar well">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="./2020-11-04_maven-deploy-jar-and-scripts.html">maven-assembly-pluginで配布用アーカイブを作成する</a></li>
        
          <li><a href="./2020-11-03_git-stash-collection.html">個人的git-stashまとめ</a></li>
        
          <li><a href="./2020-10-31_java-info-collection.html">個人的Java情報まとめ</a></li>
        
          <li><a href="./2020-10-04_hakyll_teaser.html">Hakyllでのteaser（続きを読む）の設定</a></li>
        
          <li><a href="./2020-09-15_webapp_security_02.html">Webアプリケーションセキュリティ - クロスサイト・リクエストフォージェリ（CSRF）</a></li>
        
    </ul>
</div>

<div class="sidebar well">
<h1>Links</h1>
<ul>
  <li><a target="_blank" href="https://hoogle.haskell.org/">Hoogle</a></li>
  <li><a target="_blank" href="https://www.stackage.org/">Stackage Server</a></li>
  <li><a target="_blank" href="https://scrapbox.io/haskell-shoen/">Haskell荘園</a></li>
</ul>

</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well main">
              <h1>maven-assembly-pluginで配布用アーカイブを作成する</h1>
            <!-- コメント機能は別途追加する -->
            <!-- {% if site.comments and page.comments %} -->
            <!--     {% if site.disqus != '' %} -->
            <!--     <p class="author"><a href="#disqus_thread" data-disqus-identifier="{{ page.url | slugify }}">Comments</a></p> -->
            <!--     {% elsif site.isso != '' %} -->
            <!--     <p class="author"><a href="{{ site.baseurl }}{{ page.url }}{{ site.isso_suffix }}#isso-thread">Comments</a></p> -->
            <!--     {% endif %} -->
            <!-- {% endif %} -->
            <div class="post-content">
            <p>Mavenで、アーティファクトと実行用スクリプト等を含んだアーカイブを作成しようとしたとき、<br />
真っ先に思いつくのがmaven-assembly-pluginを使用することだと思う。</p>
<p>今回、 (展開するだけでデプロイできるように) 実行可能jarや実行用スクリプトをアーカイブしようとして、<br />
いくつかハマった箇所があったので、メモしておく。</p>
<p>なお、今回は実行可能jarはuber-jarとはしない (uber-jarとする場合は、maven-shade-pluginが必要になる) 。</p>
<p><!--more--></p>
<h2 id="maven-assembly-pluginとは">maven-assembly-pluginとは</h2>
<p><a href="http://maven.apache.org/plugins/maven-assembly-plugin/index.html">http://maven.apache.org/plugins/maven-assembly-plugin/index.html</a></p>
<p>ファイルやディレクトリをかき集めてきて、指定の形式にアーカイブするためのプラグイン。<br />
今回は、実行可能jarと実行用スクリプトをtar.gz形式でアーカイブする。</p>
<p>アーカイブ設定は、<a href="http://maven.apache.org/plugins/maven-assembly-plugin/descriptor-refs.html">事前定義された設定</a>を使用する他に、独自定義を使用することもできる。<br />
前者の場合は <code>pom.xml</code> に設定を記載するだけで良いが、後者の場合は、 <a href="http://maven.apache.org/plugins/maven-assembly-plugin/assembly.html">Assembly Descriptor Format</a>にしたがって<br />
設定ファイルを作成する必要がある。<br />
今回は、スクリプト等の配置も自由に設定したかったため、後者で実行する。</p>
<h2 id="使用するプロジェクトについて">使用するプロジェクトについて</h2>
<h3 id="プロジェクト構成">プロジェクト構成</h3>
<p>今回は、 <code>maven-archetype-quickstart</code> アーキタイプを元に、以下のようなプロジェクト構成とした (テストは省略) 。</p>
<div class="sourceCode" id="cb1" data-org-language="sh"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">assemblytest</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>├── <span class="ex">distribution.xml</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>├── <span class="ex">pom.xml</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>└── <span class="ex">src</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>    ├── <span class="ex">main</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>    │   └── <span class="ex">java</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>    │       └── <span class="ex">com</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>    │           └── <span class="ex">myapp</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>    │               └── <span class="ex">App.java</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>    ├── <span class="ex">shellscript</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    │   ├── <span class="ex">bin</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>    │   │   └── <span class="ex">test.sh</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>    │   ├── <span class="ex">conf</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>    │   │   └── <span class="ex">common.sh</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    │   └── <span class="ex">deploy.sh</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    └── <span class="bu">test</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>        └── <span class="ex">java</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>            └── <span class="ex">com</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a>                └── <span class="ex">myapp</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a>                    └── <span class="ex">AppTest.java</span></span></code></pre></div>
<h3 id="アーカイブ構成">アーカイブ構成</h3>
<p>最終的なアーカイブは、以下のような構成になっているようにする。</p>
<div class="sourceCode" id="cb2" data-org-language="sh"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ex">deployment.tar.gz</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>├── <span class="ex">app</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>│   ├── <span class="ex">java</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>│   │   ├── <span class="ex">assemblytest.jar</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>│   │   └── <span class="ex">deplib</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>│   │       ├── <span class="ex">logback-classic-1.1.3.jar</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>│   │       ├── <span class="ex">logback-core-1.1.3.jar</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>│   │       └── <span class="ex">slf4j-api-1.7.7.jar</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>│   └── <span class="ex">script</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>│       ├── <span class="ex">bin</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>│       │   └── <span class="ex">test.sh</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>│       └── <span class="ex">conf</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>│           └── <span class="ex">common.sh</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>└── <span class="ex">deploy.sh</span></span></code></pre></div>
<p><code>assemblytest.jar</code> 内の <code>META-INF/MANIFEST.MF</code> ファイルにて <code>deplib</code> 配下のjarにクラスパスを通すことで、<br />
<code>assemblytest.jar</code> が実行可能jarとなる。</p>
<p>デプロイ時は、 <code>deploy.sh</code> を実行する。そうすると、 <code>app/</code> がデプロイ先に配置されるようにする。</p>
<p>デプロイ後、 <code>test.sh</code> を実行すると、 <code>common.sh</code> を読み込んでから <code>assemblytest.jar</code> を実行する。<br />
(ここではシェルスクリプトやアプリケーションコードの中は見ない)</p>
<h3 id="pom">POM</h3>
<p><code>pom.xml</code> は以下を参照。</p>
<p><a href="https://gist.github.com/chupaaaaaaan/0a3cab43fb2148af696eb8178b89509d#file-pom-xml">https://gist.github.com/chupaaaaaaan/0a3cab43fb2148af696eb8178b89509d#file-pom-xml</a></p>
<p>ここで、 <code>maven-archetype-quickstart</code> から、以下を変更した。</p>
<ul>
<li>実行時に必要な依存関係として、LogBackを追加 (依存関係が存在するjarでの確認をしたいため)<br />
</li>
<li>プラグインとして、 <code>maven-jar-plugin</code> 、 <code>maven-assembly-plugin</code> を追加 (後述)</li>
</ul>
<h3 id="アーカイブ設定ファイル">アーカイブ設定ファイル</h3>
<p><code>distribution.xml</code> は、独自定義のアーカイブ設定。ファイル名は任意で、プラグイン設定に記載する。<br />
ファイルの内容は以下を参照。</p>
<p><a href="https://gist.github.com/chupaaaaaaan/0a3cab43fb2148af696eb8178b89509d#file-distribution-xml">https://gist.github.com/chupaaaaaaan/0a3cab43fb2148af696eb8178b89509d#file-distribution-xml</a></p>
            </div>
            <!-- コメント機能は別途追加する -->
            <!-- {% if page.comments %} -->
            <!--     {% if site.disqus != '' %} -->
            <!-- <div id="disqus_thread"> -->
            <!--     <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> -->
            <!--     <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->
            <!-- </div> -->
            <!--     {% elsif site.isso != '' %} -->
            <!--     <section id="isso-thread"></section> -->
            <!--     {% endif %} -->
            <!-- {% endif %} -->
            </div>
          </div>
          <div class="pagination">
              <!-- ページネーションは別途追加する -->
              <!-- {% if page.next %} -->
              <!--   <a class="btn btn-default" href="{{ site.baseurl}}{{ page.next.url }}" class="next">Newer Post</a> -->
              <!-- {% endif %} -->
              <!-- {% if page.previous %} -->
              <!--   <a class="btn btn-default" href="{{ site.baseurl}}{{ page.previous.url }}" class="previous">Older Post</a> -->
              <!-- {% endif %} -->
          </div>
        </div>
    </div>
</div>

<!-- コメント機能は別途追加する -->
<!-- {% if site.comments and page.comments and site.disqus != '' %} -->
<!--   <script type="text/javascript"> -->
<!--     var disqus_shortname = '{{ site.disqus }}'; -->

<!--     var disqus_config = function () { -->
<!--         this.page.identifier = '{{ page.url | slugify }}'; -->
<!--     }; -->

<!--    (function() { -->
<!--      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; -->
<!--      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; -->
<!--      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); -->
<!--     })(); -->
<!--   </script> -->
<!-- {% endif %} -->

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">
              &copy;2020 コーヒーと線香と万年筆. Powered by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>, 
              theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a> 
              under <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a>,
              theme adjusted to Hakyll by Takayuki Uchida
            </p>
        </div>
    </div>
</div>

<!-- コメント機能は別途追加する -->
<!-- {% if site.comments and site.disqus != '' %} -->
<!--   <script type="text/javascript"> -->
<!--     var disqus_shortname = '{{ site.disqus }}'; -->

<!--     var disqus_config = function () { -->
<!--         this.page.identifier = '{{ page.url | slugify }}'; -->
<!--     }; -->

<!--    (function () { -->
<!--      var s = document.createElement('script'); s.async = true; -->
<!--      s.type = 'text/javascript'; -->
<!--      s.src = '//' + disqus_shortname + '.disqus.com/count.js'; -->
<!--      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); -->
<!--    }()); -->
<!--  </script> -->
<!-- {% endif %} -->




</body>
</html>


<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>コーヒーと線香と万年筆</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="./css/theme.css" rel="stylesheet" type="text/css">
    <link href="./css/syntax.css" rel="stylesheet" type="text/css">
<!-- コメント機能は別途追加する -->
<!-- {% if site.comments and site.isso != '' %} -->
<!-- <script data-isso="{{ site.isso }}" src="/js/embed.min.js"></script> -->
<!-- {% endif %} -->

</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="./">コーヒーと線香と万年筆</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="./">Home</a></li>
                    <li class="active visible-xs-block"><a href="./links.html">Links</a></li>
                    <li class="active"><a href="./archive.html">Archive</a></li>
                    <li class="active"><a href="./about.html">About</a></li>
                    <li class="active"><a href="./atom.xml">RSS</a></li>
                    
                      <li class="active"><a href="https://github.com/chupaaaaaaan">Github</a></li>
                    
                    
                      <li class="active"><a href="https://qiita.com/chupaaaaaaan">Qiita</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well">
勉強したことおきば
</div>

<div class="sidebar well">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="./2020-07-19_encoding_mismatch_between_server_and_client.html">GitBash（MSYS2）でsshしたときの文字化けを解消する</a></li>
        
          <li><a href="./2020-07-18_change_theme.html">ブログのテーマを変更した</a></li>
        
          <li><a href="./2020-07-09_first_post.html">ブログを始めた</a></li>
        
    </ul>
</div>

<div class="sidebar well">
<h1>Links</h1>
<ul>
  <li><a target="_blank" href="https://hoogle.haskell.org/">Hoogle</a></li>
  <li><a target="_blank" href="https://www.stackage.org/">Stackage Server</a></li>
  <li><a target="_blank" href="https://scrapbox.io/haskell-shoen/">Haskell荘園</a></li>
</ul>

</div>

        </div>
        <div class="col-md-9">
            
<div class="article">
  <div class="well">
        <h1><a href="./2020-07-19_encoding_mismatch_between_server_and_client.html">2020-07-19 (Sun) - GitBash（MSYS2）でsshしたときの文字化けを解消する</a></h1>
        <!-- コメント機能は別途追加する -->
        <!-- {% if site.comments and post.comments %} -->
        <!--     {% if site.disqus != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}/#disqus_thread" data-disqus-identifier="{{ post.url | slugify }}">Comments</a></p> -->
        <!--     {% elsif site.isso != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}{{ site.isso_suffix }}#isso-thread">Comments</a></p> -->
        <!--     {% endif %} -->
        <!-- {% endif %} -->
        <div class="content">
            <h1 id="はじめに">はじめに</h1>
<p>タイトルまんまです。</p>
<p>やんごとなき理由により、Linuxサーバ（RHEL7）でとあるユーザの文字エンコーディングをUTF-8からEUC-JPに変更する必要があった。 ちゃんと <code>ja_JP.eucjp</code> もインストールされていたので、対象ユーザの <code>~/.bash_profile</code> に以下を設定すれば良い。</p>
<div class="sourceCode" id="cb1" data-org-language="sh"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>$ <span class="fu">cat</span> ~/.bash_profile <span class="kw">|</span> <span class="fu">grep</span> LANG</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="va">LANG=</span>ja_JP.eucjp</span></code></pre></div>
<p>設定されているかの確認は以下（ <code>source</code> するか、再ログインしてから確認する） 。</p>
<div class="sourceCode" id="cb2" data-org-language="sh"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>$ <span class="fu">env</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;^LANG=&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="va">LANG=</span>ja_JP.eucjp</span></code></pre></div>
<p>これでちゃんと日本語が表示されるはずなのだが、GitBashでsshして接続すると、何故か文字化けしてしまう。</p>
<h1 id="原因">原因</h1>
<p>まんまこれと同じでした。</p>
<ul>
<li><a href="https://ja.stackoverflow.com/questions/55304/msys2-%25E3%2581%25AE-ssh-%25E3%2581%25A7euc-jp%25E7%2592%25B0%25E5%25A2%2583%25E3%2581%25AB%25E3%2583%25AA%25E3%2583%25A2%25E3%2583%25BC%25E3%2583%2588%25E6%258E%25A5%25E7%25B6%259A%25E3%2581%2597%25E3%2581%259F%25E5%25A0%25B4%25E5%2590%2588%25E3%2581%25AB%25E6%2596%2587%25E5%25AD%2597%25E5%258C%2596%25E3%2581%2591%25E3%2582%2592%25E5%259B%259E%25E9%2581%25BF%25E3%2581%2599%25E3%2582%258B%25E6%2596%25B9%25E6%25B3%2595">msys2 の ssh でeuc-jp環境にリモート接続した場合に文字化けを回避する方法</a></li>
</ul>
<p>GitBash（Git for Windowsに同梱されているシェル環境）は<a href="https://qiita.com/Ted-HM/items/9a60f6fcf74bbd79a904#git-for-windows">MSYS2ベース</a>なので、同じ現象に該当すると思われる。 状況としては、サーバからEUC-JPエンコーディングのバイナリが送られているが、クライアント側で別のエンコーディングのデータとして解釈されており、結果として文字化けが発生しているようだ。</p>
<h1 id="解決">解決</h1>
<p>同じページの回答にある、 <code>luit</code> というツールを導入することで解消した。このツールは、プロセスの間に立って受け取るデータのエンコーディングをいい感じに変換してくれるみたい。 <code>luit.exe</code> のバイナリをパスの通ったディレクトリに起き、以下を実行すれば文字化けなく表示される。</p>
<div class="sourceCode" id="cb3" data-org-language="sh"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">luit.exe</span> -encoding eucjp -- ssh <span class="va">${SERVERNAME}</span></span></code></pre></div>
<p>毎回これをするのはめんどいが、そんなに実行する機会もないはずなので、一旦はこれでOK。 （当初はサーバ側の問題と勘違いし、設定方法を確認したり<a href="https://qiita.com/qiitamatumoto/items/efffc0ef6e6249533201">このあたり</a>やってみたりで半日くらい時間を溶かしてしまったのは秘密。）</p>
<h2 id="ちなみに">ちなみに</h2>
<p>同様にクライアントが受け取る文字エンコーディングをいい感じに変換してくれるツールとして、 <a href="https://qiita.com/Ted-HM/items/9a60f6fcf74bbd79a904#cocot">cocot</a>というのもある。 最初自分もこちらを試してみたが、うまく動かせなかった（多分使い方が間違ってる）。</p>
<h1 id="補記">補記</h1>
<p>Windowsで使えるシェル環境ってあんまり知らなかったけど、調べている中で面白い記事を発見した。</p>
<ul>
<li><a href="https://qiita.com/Ted-HM/items/9a60f6fcf74bbd79a904">Windowsで使えるターミナルとシェルのまとめ</a></li>
</ul>
<p>結構いろんなシェル環境があるんだなー。普段はGitBash（か、たまにCygwin）のどっちかしか使ってないけど、ちょっと他のも使ってみようかな。</p>
        </div>
    </div>
</div>

<div class="article">
  <div class="well">
        <h1><a href="./2020-07-18_change_theme.html">2020-07-18 (Sat) - ブログのテーマを変更した</a></h1>
        <!-- コメント機能は別途追加する -->
        <!-- {% if site.comments and post.comments %} -->
        <!--     {% if site.disqus != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}/#disqus_thread" data-disqus-identifier="{{ post.url | slugify }}">Comments</a></p> -->
        <!--     {% elsif site.isso != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}{{ site.isso_suffix }}#isso-thread">Comments</a></p> -->
        <!--     {% endif %} -->
        <!-- {% endif %} -->
        <div class="content">
            <h1 id="はじめに">はじめに</h1>
<p>hakyllのデフォルトのブログテーマではちょっと味気なかったので、別のブログテーマに変更した。</p>
<p>参考にしたのはこちら。</p>
<ul>
<li><a href="https://matsubara0507.github.io/posts/2016-10-24-changed-design.html">Hakyll で作った GitHub Pages のデザインを変更してみた</a></li>
</ul>
<p>同じく、<a href="http://katychuang.com/hakyll-cssgarden/gallery/">ここ</a>や<a href="https://jaspervdj.be/hakyll/examples.html">このあたり</a>を見てみたが、あまりしっくり来なかったので<a href="http://jekyllthemes.org/">jekyll</a>のテーマから探すことにした。 自分が選択したテーマは<a href="http://jekyllthemes.org/themes/jekyll-clean/">jekyll-clean</a>で、こちらをhakyllで使えるように修正した。</p>
<p>基本的にはmatsubaraさんの記事をなぞれば変換できる・・・のだが、今回私が選んだテーマではひと工夫が必要だった。 割と嵌ってしまったので、どう解決したか書く。</p>
<p>なお、今回は「シンタックスハイライト」及び「configファイル」の対応はやってない。 また、元のテーマにはdisqus及びissoによるコメント機能、google analytics、ページネーションなども実装されていたが、 これらも今回は対応していない（コメントアウトした）。 ゆくゆくは対応したい。</p>
<p>今回対応したテーマは<a href="https://github.com/chupaaaaaaan/chupaaaaaaan.github.io">こちら</a>に置いてある。</p>
<h1 id="サイドバーの対応">サイドバーの対応</h1>
<p>画面を見ればわかる（デスクトップで最大化しないと見えないかも・・・）が、今回選んだテーマは、サイドバーに各記事のリンクが貼ってある（Recent Posts）。</p>
<p>単純には、以下のように実装すれば良さそうである。 （ <code>gsubRoute</code> を使って、ルーティングを変更している。）</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>match <span class="st">&quot;posts/*&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    route <span class="op">$</span> gsubRoute <span class="st">&quot;posts/&quot;</span> (<span class="fu">const</span> <span class="st">&quot;&quot;</span>) <span class="ot">`composeRoutes`</span> setExtension <span class="st">&quot;html&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>        recentPosts <span class="ot">&lt;-</span> recentFirst <span class="op">=&lt;&lt;</span> loadAll <span class="st">&quot;posts/*&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>        <span class="kw">let</span> postsCtx <span class="ot">=</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>                listField <span class="st">&quot;recent_posts&quot;</span> postCtx (<span class="fu">return</span> <span class="op">$</span> <span class="fu">take</span> <span class="dv">5</span> recentPosts) <span class="ot">`mappend`</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>                postCtx <span class="ot">`mappend`</span> siteCtx</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>        pandocCompiler</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>          <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;layouts/post.html&quot;</span> postsCtx</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>          <span class="op">&gt;&gt;=</span> relativizeUrls</span></code></pre></div>
<p><code>compile</code> でやっていることを説明すると、</p>
<ol>
<li><code>posts/*</code> パターンにマッチするコンテンツを作成日時の降順で <code>recentPosts</code> として取得し、</li>
<li>（サイドバーで参照する） <code>recent_posts</code> をキーとして、 <code>recentPosts</code> をコンテキストに入れて、</li>
<li><code>posts/*</code> にマッチするコンテンツを <code>pandocCompiler</code> でコンパイルし、</li>
<li>出来上がったものを <code>layouts/post.html</code> に突っ込む（テンプレート内で <code>$body$</code> と記載されている箇所に代入される）</li>
</ol>
<p>となる。ところが、これをコンパイルすると、以下のようなエラーが出てしまう。</p>
<pre><code>[ERROR] Hakyll.Core.Runtime.chase: Dependency cycle detected: posts/2020-07-09_first_post.org depends on posts/2020-07-09_first_post.org
</code></pre>
<p>どうやら、循環参照が発生しているというメッセージのようだ。実際、 <code>posts/*</code> をコンパイルする前に <code>recentPosts</code> として取得しようとしている。 取得のためにコンパイルし、その中でさらに取得し・・・とループしてしまう。</p>
<p>この問題は、stackoverflowの記事（<a href="https://stackoverflow.com/questions/35645525/hakyll-says-dependency-cycle-detected">ここ</a>とか<a href="https://stackoverflow.com/questions/47067851/how-do-i-avoid-a-dependency-cycle-when-generating-a-list-of-recent-posts-on-post">ここ</a>とか）が参考になる。 ざっくり言えば、別バージョンのコンテンツを作成し、 <code>recentPosts</code> として取得するコンテンツはこちらのバージョンを使用する。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>match <span class="st">&quot;posts/*&quot;</span> <span class="op">$</span> version <span class="st">&quot;postContents&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  route <span class="op">$</span> gsubRoute <span class="st">&quot;posts/&quot;</span> (<span class="fu">const</span> <span class="st">&quot;&quot;</span>) <span class="ot">`composeRoutes`</span> setExtension <span class="st">&quot;html&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  compile <span class="op">$</span> pandocCompiler <span class="op">&gt;&gt;=</span> relativizeUrls</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>match <span class="st">&quot;posts/*&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    route <span class="op">$</span> gsubRoute <span class="st">&quot;posts/&quot;</span> (<span class="fu">const</span> <span class="st">&quot;&quot;</span>) <span class="ot">`composeRoutes`</span> setExtension <span class="st">&quot;html&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>        recentPosts <span class="ot">&lt;-</span> recentFirst <span class="op">=&lt;&lt;</span> loadAll (<span class="st">&quot;posts/*&quot;</span> <span class="op">.&amp;&amp;.</span> hasVersion <span class="st">&quot;postContents&quot;</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>        <span class="kw">let</span> postsCtx <span class="ot">=</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>                listField <span class="st">&quot;recent_posts&quot;</span> postCtx (<span class="fu">return</span> <span class="op">$</span> <span class="fu">take</span> <span class="dv">5</span> recentPosts) <span class="ot">`mappend`</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>                postCtx <span class="ot">`mappend`</span> siteCtx</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>        pandocCompiler</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>          <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;layouts/post.html&quot;</span> postsCtx</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>          <span class="op">&gt;&gt;=</span> relativizeUrls</span></code></pre></div>
<p>注意すべきポイントとしては、別バージョンのコンテンツを作成する際に <code>route</code> も正しく設定する必要がある。 <code>route</code> を省略してもコンパイルエラーにはならないが、 <code>recent_posts</code> として参照したコンテンツへのリンクが作成されない （ <code>defaultContext</code> に格納される <code>$url$</code> が空になるっぽい）。</p>
<h2 id="ちなみに">ちなみに</h2>
<p>循環参照を解決する手段としては、複数のバージョンのコンテンツを用意する方法の他に、<a href="https://groups.google.com/g/hakyll/c/F2j7iztwKEc/m/axLNmksqCAAJ?pli=1">作者から提案された方法</a>もある。 どうやら、「必要なのはメタデータだけなんだから、それだけ取得すればよくね？」ということみたいなのだが、 どうやればよいのかよくわからなかったので、今回は不採用。</p>
<p>hakyllに出てくる <code>Context a</code> 、 <code>Item a</code> 、 <code>Compiler a</code> などは重要な概念っぽいのだが、まだよくわかってない・・・。</p>
<h1 id="コンテンツの表示">コンテンツの表示</h1>
<p>上記で循環参照のエラーはなくなるが、まだ問題はある。</p>
<p>ドキュメントルート（ <code>index.html</code> ）では、以下のコンテンツが表示される。</p>
<ul>
<li>サイドバー
<ul>
<li>Description</li>
<li>Recent Posts</li>
<li>Links</li>
</ul></li>
<li>メインコンテンツ
<ul>
<li>最新のコンテンツから順に表示</li>
</ul></li>
</ul>
<p>最初、以下のように実装していた。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>match (fromList [<span class="st">&quot;archive.html&quot;</span>, <span class="st">&quot;about.html&quot;</span>, <span class="st">&quot;index.html&quot;</span>, <span class="st">&quot;links.html&quot;</span>]) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    route idRoute</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>        posts <span class="ot">&lt;-</span> recentFirst <span class="op">=&lt;&lt;</span> loadAll <span class="st">&quot;posts/*&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>        <span class="kw">let</span> postsCtx <span class="ot">=</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>                listField <span class="st">&quot;recent_posts&quot;</span> postCtx (<span class="fu">return</span> <span class="op">$</span> <span class="fu">take</span> <span class="dv">5</span> posts) <span class="ot">`mappend`</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>                listField <span class="st">&quot;posts&quot;</span> postCtx (<span class="fu">return</span> posts) <span class="ot">`mappend`</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>                siteCtx</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>        getResourceBody</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> applyAsTemplate postsCtx</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;layouts/default.html&quot;</span> postsCtx</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> relativizeUrls</span></code></pre></div>
<p>今回は循環参照にはならないので、 <code>posts &lt;- recentFirst =&lt;&lt; loadAll "posts/*"</code> のように書いてもコンパイルエラーにはならない。</p>
<p>が、このように書いてしまうと、2つの問題が発生する。</p>
<ol>
<li>Recent Postsに、同じコンテンツへのリンクが2つ表示される</li>
<li>コンテンツが表示される領域に、（サイドバーを含めて）コンテンツがネストされて表示される（ちょっと説明が難しい・・・）</li>
</ol>
<p>ひとつめの問題は、 <code>posts &lt;- recentFirst =&lt;&lt; loadAll "posts/*"</code> のように書いた時に、 <code>posts/*</code> にマッチする全てのコンテンツが取得されてしまうことが原因である。 つまり、バージョン指定なしでコンパイルしたコンテンツと、バージョンを明示したコンテンツのどちらにもマッチしてしまう。 これを防ぐためには、バージョン指定するか、明示的にバージョンが存在しないコンテンツにマッチするように書く必要がある。</p>
<p>こんな感じ。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>posts <span class="ot">&lt;-</span> recentFirst <span class="op">=&lt;&lt;</span> loadAll (<span class="st">&quot;posts/*&quot;</span> <span class="op">.&amp;&amp;.</span> hasNoVersion)</span></code></pre></div>
<p>ふたつめの問題は、 <code>posts/*</code> （のバージョンなし版）にマッチするコンテンツは、既にサイドバーも含めてコンパイル済みであることから来ている （そのようなコンテンツをテンプレートに埋め込もうとするため、コンテンツがネストされてしまう）。 そのため、テンプレートを適用する前で止めたバージョンのコンテンツ（サイドバーやヘッダーがくっついていない）を取得し、 それを使用してコンパイル・テンプレート埋め込みを実施すればよい。</p>
<p>今回で言えば、 <code>postContents</code> のバージョンがテンプレートを適用していないコンテンツであるため、そちらを取得すればよい。</p>
<p>最終的には、こんな感じ（ <code>hasNoVersion</code> は使用しない）。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>match (fromList [<span class="st">&quot;index.html&quot;</span>]) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    route idRoute</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>        posts <span class="ot">&lt;-</span> recentFirst <span class="op">=&lt;&lt;</span> loadAll (<span class="st">&quot;posts/*&quot;</span> <span class="op">.&amp;&amp;.</span> hasVersion <span class="st">&quot;postContents&quot;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>        <span class="kw">let</span> postsCtx <span class="ot">=</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>                listField <span class="st">&quot;recent_posts&quot;</span> postCtx (<span class="fu">return</span> <span class="op">$</span> <span class="fu">take</span> <span class="dv">5</span> posts) <span class="ot">`mappend`</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>                listField <span class="st">&quot;posts&quot;</span> postCtx (<span class="fu">return</span> posts) <span class="ot">`mappend`</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>                siteCtx</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        getResourceBody</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> applyAsTemplate postsCtx</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;layouts/default.html&quot;</span> postsCtx</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>            <span class="op">&gt;&gt;=</span> relativizeUrls</span></code></pre></div>
<h2 id="ちなみにその2">ちなみにその2</h2>
<p>テンプレートを適用する前のコンテンツを取得する方法としては、別バージョンの記事を使用する代わりに<a href="https://jaspervdj.be/hakyll/tutorials/05-snapshots-feeds.html">スナップショットを利用する方法</a>もある。 こっちの方が、コンパイルを余計に実施しない分効率が良さそうだが、既に循環参照を解決するために別バージョンのコンテンツを作成しているので、 スナップショット方式は採用していない。</p>
<h1 id="終わりに">終わりに</h1>
<p>とりあえず見た目はなんとかなった。いじってみると、かなり自由度高くカスタマイズ出来そうなので、ちょこちょこ変えていこうかな。</p>
        </div>
    </div>
</div>

<div class="article">
  <div class="well">
        <h1><a href="./2020-07-09_first_post.html">2020-07-09 (Thu) - ブログを始めた</a></h1>
        <!-- コメント機能は別途追加する -->
        <!-- {% if site.comments and post.comments %} -->
        <!--     {% if site.disqus != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}/#disqus_thread" data-disqus-identifier="{{ post.url | slugify }}">Comments</a></p> -->
        <!--     {% elsif site.isso != '' %} -->
        <!--     <p class="author"><a href="{{ site.baseurl }}{{ post.url }}{{ site.isso_suffix }}#isso-thread">Comments</a></p> -->
        <!--     {% endif %} -->
        <!-- {% endif %} -->
        <div class="content">
            <p>いろいろ思うところがあり、ブログを運用することにしました。</p>
<h1 id="はじめに">はじめに</h1>
<p>もともと同名のブログをはてなブログで運営していたが（運営していたというほど記事をポストしていたわけではない）、 なんとなく愛着がわかないなー、と思っていた。</p>
<p>そんな中で、GitHub Pagesというものがあるのを知ったり（正確には前から知っていたが見えてなかった）、 Haskellでブログ書いてるー、みたいな記事をいくつか見つけたので、ちょっとやってみっか、と一念発起。</p>
<h1 id="hakyllのセットアップ">Hakyllのセットアップ</h1>
<p>今回は、単にhaskellを使いたいのと、記事はorg-modeで書きたいので、Hakyllを使うことにした。 Hakyllは内部でpandocを使っており、markdownやorgをhtmlに変換してくれる。 （実はpandocをほとんど使ったことがないので、どのくらいちゃんと変換できるか、とかは知らない）</p>
<p>セットアップに当たっては以下を参考にした。（matsubaraさんのが特に参考になった。結構まねてる。）</p>
<ul>
<li><a href="https://matsubara0507.github.io/posts/2016-07-07-started-github-pages.html">GitHub Paghes はじめました</a></li>
<li><a href="https://myuon.github.io/posts/hakyll-blog/">HakyllでBlogを作る</a></li>
<li><a href="https://hackage.haskell.org/package/hakyll">hakyll: A static website compiler library</a></li>
<li><a href="https://jaspervdj.be/hakyll/tutorials.html">TUTORIALS ABOUT HAKYLL</a></li>
</ul>
<p>インストール〜プロジェクト作成は、</p>
<pre class="shell"><code>$ stack install hakyll
$ stack exec hakyll-init my_site
</code></pre>
<p>とするだけ。プロジェクトを作成したら、 <code>stack.yaml</code> を作っておく。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">resolver</span><span class="kw">:</span><span class="at"> lts-16.3</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="fu">packages</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="kw">-</span><span class="at"> .</span></span></code></pre></div>
<p>プロジェクトを作成したばかりでも、 <code>stack build &amp;&amp; stack exec site build &amp;&amp; stack exec site watch</code> でサンプルサイトが立ち上がる （http://localhost:8000 から見ることができる）。 出来上がった <code>site.hs</code> やhackageを見つつ、どんな処理してるのかを確認する。</p>
<p><code>stack exec site build</code> すると、デフォルトでは、 <code>_site</code> 配下にビルドされた静的コンテンツが、 <code>_cache</code> 配下に何らかのキャッシュが作成される。 これらは <code>.gitignore</code> で管理対象外にしておく（ついでに <code>.stack-work</code> も）。</p>
<h1 id="github-pagesへのデプロイ">GitHub Pagesへのデプロイ</h1>
<p>ほとんどこれ。</p>
<ul>
<li><a href="https://jaspervdj.be/hakyll/tutorials/github-pages-tutorial.html">TUTORIAL: USING HAKYLL WITH GITHUB PAGES</a></li>
</ul>
<p><code>source</code> ブランチで記事を書き、ビルドしたコンテンツを <code>master</code> ブランチに反映させる。 ポイントは、 <code>source</code> ブランチはもとの記事やビルド用資材のみ、 <code>master</code> ブランチはコンテンツのみ持っているということだ。 <code>_site</code> をGit管理対象外にしておくことで、このディレクトリを通じて、 <code>master</code> ブランチがコンテンツのみ持っている、という状況を作り出せる。 （こういう使い方をするのは初めて見たが、参考になる。）</p>
<p>ビルドとデプロイが手軽にできるよう、手順を簡単なスクリプトにしておいた。</p>
<h2 id="ちなみに">ちなみに</h2>
<p>最初勘違いしていたが、GitHub Pagesでは、大きく分けて2つの公開方法がある。</p>
<dl>
<dt>ユーザー/Organizationページ</dt>
<dd>&lt;user/organization name&gt;.github.io/
</dd>
<dt>プロジェクトページ</dt>
<dd>&lt;username&gt;.github.io/&lt;repository&gt;/
</dd>
</dl>
<p>（参考：<a href="https://docs.github.com/ja/github/working-with-github-pages/about-github-pages">GitHub Pages について</a>）</p>
<p>当初はプロジェクトページとして作成していた。 この場合は、公開対象が <code>master</code> ブランチ直下以外に、 <code>master</code> ブランチ直下の <code>docs/</code> ディレクトリも選択することができる。 こうすると、わざわざ <code>source</code> ブランチと <code>master</code> ブランチを分けなくて楽だなー、と思っていたが、 パスの先頭に <code>&lt;repository&gt;</code> をつけないとだめで、そのままビルドしてもGitHub Pagesでは閲覧できない。 （ちゃんと作り込めばいいんだろうけど、そこまでするのはめんどくさい。）</p>
<h1 id="そのうち直したいなーなど">そのうち直したいなー、など</h1>
<p>スタイルとかは何も考えずに作ったので、デフォルトのままでちょっとださい。これは近いうちに修正しようと思う。 他にやっておきたいことは以下かなー。</p>
<dl>
<dt>タグ機能</dt>
<dd>まだ記事が少ないからいいけど、記事が多くなったら分類できるようにしたい。
</dd>
<dt>ページネーション</dt>
<dd>これはまあ、特になくてもいいかも。あると便利、くらい。
</dd>
</dl>
<h1 id="追記-2020-07-09">追記 (2020-07-09)</h1>
<p>hakyllでは、記事の頭にタイトルなどのメタ情報を埋め込むことができる。 メタ情報として <code>published: yyyy-mm-dd</code> とかくと、記事にタイムスタンプをつけることができる。 タイムスタンプは、 <code>recentFirst</code> で記事を並べ替えたり、テンプレート内で日付を表示したりといったことに使う。 （<a href="https://hackage.haskell.org/package/hakyll-4.13.4.0/docs/Hakyll-Web-Template-Context.html">https://hackage.haskell.org/package/hakyll-4.13.4.0/docs/Hakyll-Web-Template-Context.html</a> の <code>dateField</code> あたりに書いてある）</p>
        </div>
    </div>
</div>


<!-- ページネーションは別途追加する -->
<!-- <div class="pagination"> -->
<!--   {% if paginator.previous_page %} -->
<!--       {% if paginator.previous_page == 1 %} -->
<!--         <a class="btn btn-default" href="{{ site.baseurl}}/index.html" class="previous">Newer</a> -->
<!--       {% else %} -->
<!--         <a class="btn btn-default" href="{{ site.baseurl}}/page{{ paginator.previous_page }}" class="previous">Newer</a> -->
<!--       {% endif %} -->
<!--   {% endif %} -->
<!--   <span class="page_number ">Page: {{ paginator.page }} of {{ paginator.total_pages }}</span> -->
<!--   {% if paginator.next_page %} -->
<!--     <a class="btn btn-default" href="{{ site.baseurl}}/page{{ paginator.next_page }}" class="next">Older</a> -->
<!--   {% endif %} -->
<!-- </div> -->

        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2020 コーヒーと線香と万年筆. Powered by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a>, theme adjusted to Hakyll by Takayuki Uchida</p>
        </div>
    </div>
</div>

<!-- コメント機能は別途追加する -->
<!-- {% if site.comments and site.disqus != '' %} -->
<!--   <script type="text/javascript"> -->
<!--     var disqus_shortname = '{{ site.disqus }}'; -->

<!--     var disqus_config = function () { -->
<!--         this.page.identifier = '{{ page.url | slugify }}'; -->
<!--     }; -->

<!--    (function () { -->
<!--      var s = document.createElement('script'); s.async = true; -->
<!--      s.type = 'text/javascript'; -->
<!--      s.src = '//' + disqus_shortname + '.disqus.com/count.js'; -->
<!--      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); -->
<!--    }()); -->
<!--  </script> -->
<!-- {% endif %} -->




</body>
</html>

